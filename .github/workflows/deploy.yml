name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      force_supabase_deploy:
        description: 'Force Supabase deployment even if no changes'
        required: false
        default: false
        type: boolean

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

jobs:
  # Detect what changed to skip unnecessary deployments
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      supabase: ${{ steps.filter.outputs.supabase }}
      flutter: ${{ steps.filter.outputs.flutter }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            supabase:
              - 'supabase/migrations/**'
              - 'supabase/functions/**'
            flutter:
              - 'lib/**'
              - 'web/**'
              - 'pubspec.yaml'
              - 'pubspec.lock'

  # Run all tests first
  test:
    name: Pre-deployment Tests
    uses: ./.github/workflows/ci.yml

  # Deploy Supabase migrations and Edge Functions (only if changed)
  deploy-supabase:
    name: Deploy Supabase
    runs-on: ubuntu-latest
    needs: [test, changes]
    if: needs.changes.outputs.supabase == 'true' || github.event.inputs.force_supabase_deploy == 'true' || github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link project
        run: supabase link --project-ref $SUPABASE_PROJECT_ID

      - name: Push database migrations
        run: supabase db push

      - name: Deploy Edge Functions
        run: |
          # Functions that handle their own auth (called by cron, webhooks, or DB triggers)
          # These need --no-verify-jwt because they implement internal auth validation
          NO_JWT_FUNCTIONS="process-timers process-auto-refill translate stripe-webhook health cleanup-inactive-chats submit-proposition submit-ratings create-checkout-session agent-orchestrator agent-propose agent-rate agent-chat-state agent-join-chat agent-join-by-code agent-list-chats agent-register agent-create-chat agent-results moltbook-agent"

          for func in supabase/functions/*/; do
            if [ -f "$func/index.ts" ]; then
              func_name=$(basename "$func")
              echo "Deploying $func_name..."

              # Check if this function should skip JWT verification
              if echo "$NO_JWT_FUNCTIONS" | grep -qw "$func_name"; then
                echo "  -> Deploying with --no-verify-jwt (function handles its own auth)"
                supabase functions deploy "$func_name" --no-verify-jwt
              else
                echo "  -> Deploying with JWT verification enabled"
                supabase functions deploy "$func_name"
              fi
            fi
          done

      - name: Verify deployment health
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 10

          echo "Checking health endpoint..."
          HEALTH_URL="https://$SUPABASE_PROJECT_ID.supabase.co/functions/v1/health"

          RESPONSE=$(curl -s -w "\n%{http_code}" "$HEALTH_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Health check response:"
          echo "$BODY" | jq . || echo "$BODY"

          # Check for missing secrets
          if echo "$BODY" | grep -q '"status":"fail"' && echo "$BODY" | grep -q "CRON_SECRET"; then
            echo ""
            echo "⚠️  WARNING: CRON_SECRET is not configured!"
            echo "   Cron jobs (process-timers, process-auto-refill) will fail with 401 errors."
            echo "   See docs/DEPLOYMENT.md for the required value."
            echo ""
          fi

          # Don't fail deployment for missing optional secrets, just warn
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Health check passed"
          else
            echo "⚠️  Health check returned status $HTTP_CODE (some features may be degraded)"
          fi

  # Build and deploy web app (only if Flutter files changed)
  deploy-web:
    name: Deploy Web App
    runs-on: ubuntu-latest
    needs: [test, changes]
    if: needs.changes.outputs.flutter == 'true'
    environment: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build web
        run: |
          flutter build web --release \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --dart-define=ENVIRONMENT=${{ github.event.inputs.environment || 'production' }}

      - name: Upload web build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_ONEMIND_95FB2 }}
          projectId: onemind-95fb2
          channelId: live

  # Create release notes
  release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    needs: [deploy-supabase, deploy-web]
    if: ${{ !failure() && !cancelled() }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get the last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --oneline -20)
          else
            COMMITS=$(git log --oneline "$LAST_TAG"..HEAD)
          fi

          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recent Changes" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$COMMITS" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Notify on deployment completion
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-supabase, deploy-web]
    if: always()
    steps:
      - name: Set deployment status
        run: |
          # Both jobs can be skipped when their files didn't change — treat skipped as success
          SUPABASE_OK=$([[ "${{ needs.deploy-supabase.result }}" == "success" || "${{ needs.deploy-supabase.result }}" == "skipped" ]] && echo "true" || echo "false")
          WEB_OK=$([[ "${{ needs.deploy-web.result }}" == "success" || "${{ needs.deploy-web.result }}" == "skipped" ]] && echo "true" || echo "false")

          if [[ "$SUPABASE_OK" == "true" ]] && [[ "$WEB_OK" == "true" ]]; then
            echo "DEPLOY_STATUS=success" >> $GITHUB_ENV
            echo "Deployment successful!"
            if [[ "${{ needs.deploy-supabase.result }}" == "skipped" ]]; then
              echo "(Supabase deployment skipped - no changes detected)"
            fi
            if [[ "${{ needs.deploy-web.result }}" == "skipped" ]]; then
              echo "(Web deployment skipped - no Flutter changes detected)"
            fi
          else
            echo "DEPLOY_STATUS=failed" >> $GITHUB_ENV
            echo "Deployment failed!"
            exit 1
          fi
